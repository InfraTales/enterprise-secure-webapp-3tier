name: InfraTales CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trivy Security Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Markdown Lint
        uses: nosborn/github-action-markdown-cli@v4.3.0
        with:
          files: .
          config_file: .markdownlint.json
          ignore_files: node_modules/

      - name: Validate Template
        run: |
          chmod +x scripts/validate-template.sh
          ./scripts/validate-template.sh

  iac-validate:
    name: IaC Validation
    runs-on: ubuntu-latest
    needs: [security-scan, lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect IaC Tool
        id: detect
        run: |
          if [ -f "cdk.json" ]; then
            echo "tool=cdk" >> $GITHUB_OUTPUT
          elif ls *.tf 1> /dev/null 2>&1; then
            echo "tool=terraform" >> $GITHUB_OUTPUT
          elif [ -f "Pulumi.yaml" ]; then
            echo "tool=pulumi" >> $GITHUB_OUTPUT
          else
            echo "tool=none" >> $GITHUB_OUTPUT
          fi

      # CDK
      - name: Setup Node (CDK)
        if: steps.detect.outputs.tool == 'cdk'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java (CDK Java)
        if: steps.detect.outputs.tool == 'cdk' && hashFiles('pom.xml', 'build.gradle') != ''
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '17'

      - name: Install CDK
        if: steps.detect.outputs.tool == 'cdk'
        run: npm install -g aws-cdk

      - name: CDK Synth
        if: steps.detect.outputs.tool == 'cdk'
        run: |
          if [ -f "pom.xml" ]; then
            cdk synth --app "mvn -e -q compile exec:java"
          elif [ -f "build.gradle" ]; then
            chmod +x gradlew 2>/dev/null || gradle wrapper
            ./gradlew build
            cdk synth --app "./gradlew run"
          elif [ -f "package.json" ]; then
            npm install
            cdk synth
          else
            cdk synth
          fi
        env:
          AWS_DEFAULT_REGION: us-east-1

      # Terraform
      - name: Setup Terraform
        if: steps.detect.outputs.tool == 'terraform'
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform Format Check
        if: steps.detect.outputs.tool == 'terraform'
        run: terraform fmt -check -recursive

      - name: Terraform Init
        if: steps.detect.outputs.tool == 'terraform'
        run: terraform init -backend=false

      - name: Terraform Validate
        if: steps.detect.outputs.tool == 'terraform'
        run: terraform validate

      - name: TFSec Security Scan
        if: steps.detect.outputs.tool == 'terraform'
        uses: aquasecurity/tfsec-action@v1.0.0

      # Pulumi
      - name: Pulumi Preview
        if: steps.detect.outputs.tool == 'pulumi'
        uses: pulumi/actions@v4
        with:
          command: preview
          stack-name: dev
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        continue-on-error: true

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [security-scan, lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Java
      - name: Setup Java
        if: hashFiles('pom.xml', 'build.gradle') != ''
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '17'

      - name: Run Java Tests (Maven)
        if: hashFiles('pom.xml') != ''
        run: |
          mvn test
          mvn jacoco:report

      - name: Run Java Tests (Gradle)
        if: hashFiles('build.gradle') != ''
        run: |
          chmod +x gradlew 2>/dev/null || gradle wrapper
          ./gradlew test jacocoTestReport

      # Node.js / TypeScript
      - name: Setup Node
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Node Tests
        if: hashFiles('package.json') != ''
        run: |
          npm install
          npm test -- --coverage

      # Python
      - name: Setup Python
        if: hashFiles('requirements.txt', 'setup.py') != ''
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run Python Tests
        if: hashFiles('requirements.txt', 'setup.py') != ''
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
          pytest --cov=. --cov-report=xml

      # Coverage Upload
      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: coverage/lcov.info,target/site/jacoco/jacoco.xml,coverage.xml
          fail_ci_if_error: false

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [security-scan, lint, iac-validate, test]
    if: always()
    steps:
      - name: Check Status
        run: |
          if [ "${{ needs.security-scan.result }}" == "failure" ] || \
             [ "${{ needs.lint.result }}" == "failure" ] || \
             [ "${{ needs.iac-validate.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ]; then
            echo "❌ CI Failed"
            exit 1
          else
            echo "✅ All Checks Passed"
          fi
